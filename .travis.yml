sudo: required
language: c
services: docker

env:
  global:
    - DOCKERHUB_IMG=yhnw/openwrt-sdk
    - PKG_NAME=miruo
    - QUIET=1 # 1: suppress build log / "": output all
  matrix:
    - DISTRO=openwrt-15.05.1 ARCH=ar71xx        PKG_DIR=bin/ar71xx/packages
    - DISTRO=lede-17.01.2    ARCH=ar71xx        PKG_DIR=bin/packages/mips_24kc
    - DISTRO=lede-17.01.2    ARCH=ramips-mt7620 PKG_DIR=bin/packages/mipsel_24kc
    - DISTRO=lede-17.01.2    ARCH=bcm53xx       PKG_DIR=bin/packages/arm_cortex-a9

before_install:
  - docker version
  - mkdir $PWD/pkgs
  - chmod 777 $PWD/pkgs

script:
  - docker run --rm -u openwrt -v $PWD:/work ${DOCKERHUB_IMG}:${DISTRO}-${ARCH} /bin/bash /work/build.sh ${DISTRO}-${ARCH} $PKG_DIR $PKG_NAME $QUIET
  - ls -la

after_failure:
  - if [[ -e pkgs/build.log ]]; then tail -300 pkgs/build.log; fi

deploy:
  - provider: releases
    api_key:
      secure: "oRXT6D3YcMXpJccPDP4sxYhwvXkCwz2I79zDey/wioQEvmul5sS5vnOWvmc07j/cE5VwkpraRQVXMkQxrG5KuNsinNyhtudbS9OcUTdfn0kAi09OTFv7bCDj6DGWAxvHi/aPUOFX0yDEGl6fghA+jfMT8vDbO+WWtRkiZE1Na3S/KsHY9nYaFSU/DOZMxK3b8JxSs7KPKrREgHmDoxAdyHZuIpuPnHF63DtfH4tuBD+bWzXiKZ1BMsFEoLhGMPPF5WBkxREX35SHSX61NkDu2KIKiZeE205jVllJuFZqhIrBk0JfDUyyb8QMZT6CAFkGplxDO7Ad6eYz92ER9+CIjqcqmJ0JmH5xFT3neVcHYULyVv5qHfiqkdKFXiv8XL3KEHz6QgNqPOsh3DZmlVSyioPXF7IHYFX5TziK+LKRt3DWMbDbpz5sG85tz1+XHsuUPE/dj+tLfButJtvdEryPwIIw+UlSFRgkErzVtnCV9OCm0v+t1fM07OE6EBydAUT2S3d2I1hpVVboUGMci7lhkI3g0GuJ2oueeNU9hEQ9CzUP56fCNa1AdMbfqwixVz5cpCAxFw2BhQz2BW6lwrICeAKaUy4tu5yeW5vxJrkdgWCTeRCWzzdAgeShgXOJg0xwI3qtSHh74h7AAwxknIvXnOJeUc48zXeNWJYImpAJc/8="
    file_glob: true
    file: "pkgs/for-github/*.ipk"
    skip_cleanup: true
    on:
      tags: true
  - provider: gcs
    access_key_id: "GOOGZU4AGJJUVQ4DLX52"
    secret_access_key:
      secure: "gP1Zw0fwTOvDhQocl+2DL0qHkqyKjTger+KB8HodkCuJYBhubzCdEkUnmHh7j+bNhfc95aEwcHWOeMVEn8KiAM8aRbKnhnti5Bt5FVxdwjlB9iSaL7SsGaIcjO4pXEFWxwvbuuaeoowzSP4iBKoDVtXpDmCJrDhGKuRBNFLCmE2dB2P29HOT8tIS1oBGjFYVJx09+eRCSJTGJHemE/wsnAWu6RfQ7JA2yjwXbckQB92UQbw/ox2bnqqST+oORd/z0ipRBmSXRxPr/uZP9Zp6InpSgFfeLB0PLf0e7mWvjzotrzlndEEeGOv4cATUv30eTzOBKz2lna/tU56+c7S4jtHkW6rojm3g2zcUFheEwOfSVjWrSIUQhKGlSrvdEB4cyct2OSJrVNz805n2sY0tG5r51daGWh3thDspQvbCoSL2njbZu1QEHzB0OoKhZObxu00HdqCWDEXE7XK5nUenzHDzC0hLUlwZmEZJxoItcsbz3TtdbxUvFGYF+4abAC/VEnBXAKTeWhim9GOPFzjJQsMD9kCo/21tTDEtswVDJLm/HZolPCMv2zIbzLvCzmyhlhmcwjhksGG7eTT9MlQhlBzm1Jtpxls0XG3L8qLN52LZxDxmi0xH51SSNxl3RnNl/j2cO1ZriDccELrq5objpweIyluge2OREAtNt/Wo+wk="
    bucket: "hnw-gcs-bucket-for-travis"
    skip_cleanup: true
    local-dir: pkgs/for-github/
    upload-dir: $(basename ${TRAVIS_REPO_SLUG})-${TRAVIS_BUILD_NUMBER}
    on:
      branch: master
